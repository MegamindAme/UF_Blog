{% extends 'pages/abstract/dashboard.html.twig' %}

{# Overrides blocks in head of base template #}
{% block page_title %}Blogs | Manage Blog '{{blog.slug}}'{% endblock %}
{% block page_description %}{% endblock %}

{% block body_matter %}
	<div id="postsTable" class="box box-primary">
		<div class="box-header">
			<h3 class="box-title pull-left"><i class="fa fa-fw fa-user"></i>Posts</h3>
			{% include "tables/table-tool-menu.html.twig" %}
		</div>
		<div class="box-body">
			{% include "tables/post-admin.html.twig" with {
					"table" : {
						"id" : "table-posts"
					}
				}
			%}	
		</div>
		<div class="box-footer">
			<button id="btn_create_post" type="button" class="btn btn-success js-member-create">
				<i class="fa fa-plus-square"></i>  Create Post
			</button>
		</div>
	</div>
	
{% endblock %}
{% block scripts_page %}
    <script type="text/javascript">
		{% include "pages/partials/page.js.twig" %}
		
		function bindPostButtons(el) {
			el.find('.js-edit-post').click(function() {
				$("body").ufModal({
					sourceUrl: site.uri.public + "/modals/blog/post/edit",
					ajaxParams: {
						slug: '{{blog.slug}}',
						id: $(this).data('postId')
					},
					msgTarget: $("#alerts-page")
				});
				$('body').on('renderSuccess.ufModal', function (data) {	
					$("#edit-post").ufForm({
						validators: page.validators.postEdit,
						msgTarget: $("#blog-alert")
					}).on("submitSuccess.ufForm", function(event, data, textStatus, jqXHR) {
						window.location.reload();
					});
				});	
			});
			el.find('.js-delete-post').click(function() {
				$("body").ufModal({
					sourceUrl: site.uri.public + "/modals/blog/post/delete",
					ajaxParams: {
						slug: '{{blog.slug}}',
						id: $(this).data('postId')
					},
					msgTarget: $("#alerts-page")
				});
				$('body').on('renderSuccess.ufModal', function (data) {	
					$("#post-delete").ufForm({
						msgTarget: $("#blog-alert")
					}).on("submitSuccess.ufForm", function(event, data, textStatus, jqXHR) {
						window.location.reload();
					});
				});	
			});	
		}
		
		$(document).ready(function() {		
			$("#postsTable").ufTable({
				dataUrl: site.uri.public + "/api/blogs/b/{{blog.slug}}/posts"
			});
			
			$("#postsTable").on("pagerComplete.ufTable", function () {
			    bindPostButtons($(this));
			});
			
			$("#btn_create_post").click(function() {
				$('body').ufModal({
					// URL that serves the modal HTML
					sourceUrl: site.uri.public + '/modals/blog/post/create',
					ajaxParams : {
						"blog_slug" : "{{blog.slug}}"
					},
					// Target element to display any errors generated by the modal request
					msgTarget: $('#alerts-page')
				});
				
				
				
				$('body').on('renderSuccess.ufModal', function (data) {
					
					$("#create-post").ufForm({
						validators: page.validators.postCreate,
						msgTarget: $("#blog-alert")
					}).on("submitSuccess.ufForm", function(event, data, textStatus, jqXHR) {
						window.location.reload();
					});
				});
			});
		});
		
	</script>

{% endblock %}
